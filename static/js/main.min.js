function openAddEntryModal(){const e=document.getElementById("addEntryModal");e.classList.remove("hidden"),setTimeout((()=>{e.classList.add("bg-opacity-50"),e.querySelector("div").classList.remove("scale-95","opacity-0"),e.querySelector("div").classList.add("scale-100","opacity-100")}),10)}function closeAddEntryModal(){const e=document.getElementById("addEntryModal");e.querySelector("div").classList.remove("scale-100","opacity-100"),e.querySelector("div").classList.add("scale-95","opacity-0"),e.classList.remove("bg-opacity-50"),setTimeout((()=>{e.classList.add("hidden")}),300)}function formatISBN(e){let t=e.value.replace(/\D/g,"");!t.startsWith("978")&&t.length>0&&(t="978"+t),e.value=t}function validateISBN(){const e=document.getElementById("isbn").value.replace(/\D/g,"");return!(!e.startsWith("978")||13!==e.length)||(Swal.fire({icon:"error",title:"Invalid ISBN",text:"ISBN must be 13 digits starting with 978",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}),!1)}function updateLocation(e,t){fetch(`/api/entries/${encodeURIComponent(e)}/location`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:t})}).then((e=>e.json())).then((e=>{e.error?(console.error("Error updating location:",e.error),Swal.fire({icon:"error",title:"Update Failed",text:"Could not update location",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3})):Swal.fire({icon:"success",title:"Location Updated",text:"Location has been saved successfully",toast:!0,position:"top-end",showConfirmButton:!1,timer:2e3})})).catch((e=>{console.error("Error updating location:",e)}))}let locationUpdateTimeout,searchTimeout;function debouncedUpdateLocation(e,t){clearTimeout(locationUpdateTimeout),locationUpdateTimeout=setTimeout((()=>{updateLocation(e,t)}),1e3)}function fetchEntries(e=""){let t="https://jbooks.eu.pythonanywhere.com/api/entries";return e&&(t+=`?search=${encodeURIComponent(e)}`),fetch(t).then((e=>e.json())).then((e=>{const t=document.getElementById("entriesTableBody");t.innerHTML="",e.forEach((e=>{const o=document.createElement("tr");o.className="hover:bg-gray-50 transition-colors duration-150",o.innerHTML=`\n                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${e.name}</td>\n                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.isbn}</td>\n                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">\n                        <input type="text"\n                               value="${e.location||""}"\n                               class="location-input border rounded px-2 py-1 text-sm w-full"\n                               data-isbn="${e.isbn}"\n                               oninput="debouncedUpdateLocation('${e.isbn}', this.value)">\n                    </td>\n                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.author}</td>\n                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">\n                        ${e.summary&&e.summary.length>30?`<button onclick="openDescriptionModal('${e.summary.replace(/'/g,"\\'")}')"\n                                class="text-blue-500 hover:underline">Read description</button>`:e.summary||"-"}\n                    </td>\n                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.pages}</td>\n                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.language}</td>\n                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.publishedDate}</td>\n                    <td class="px-6 py-4 whitespace-nowrap">\n                        <img src="${e.imageUrl||"http://static.photos/books/200x200"}"\n                             alt="Book cover"\n                             class="w-10 h-14 object-cover rounded hover:scale-105 transition-transform duration-200 cursor-pointer"\n                             onclick="openImageModal('${e.imageUrl||"http://static.photos/books/200x200"}')">\n                    </td>\n                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">\n                        <button onclick="deleteEntryByISBN('${e.isbn}')" class="text-red-500 hover:text-red-700">\n                            <i data-feather="trash-2" class="w-4 h-4"></i>\n                        </button>\n                    </td>\n                `,t.appendChild(o)})),feather.replace()})).catch((e=>console.error("Error fetching entries:",e)))}function deleteEntryByISBN(e){const t=String(e).trim();t&&"undefined"!==t&&"null"!==t?Swal.fire({title:"Delete Book",text:"Are you sure you want to delete this book?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, delete it!",cancelButtonText:"Cancel",reverseButtons:!0}).then((e=>{e.isConfirmed&&fetch(`https://jbooks.eu.pythonanywhere.com/api/entries/isbn/${encodeURIComponent(t)}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}).then((e=>e.text().then((t=>{const o=t.trim();try{const t=JSON.parse(o);if(!e.ok)throw t;return t}catch(e){throw console.error("JSON parse error:",e),console.error("Response that failed to parse:",o),{error:"Server returned invalid response"}}})))).then((e=>{Swal.fire({icon:"success",title:"Deleted!",text:e.message||"Book deleted successfully",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}),fetchEntries()})).catch((e=>{console.error("Full error details:",e);const t=e.error||"Failed to delete book. Please try again.";Swal.fire({icon:"error",title:"Error",text:t,toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3})}))})):Swal.fire({icon:"error",title:"Error",text:"Please provide a valid ISBN",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3})}function searchEntries(){clearTimeout(searchTimeout),searchTimeout=setTimeout((()=>{const e=document.getElementById("searchInput").value.trim();fetchEntries(e).then((()=>{if(e){const t=document.getElementById("entriesTableBody").getElementsByTagName("tr"),o=new RegExp(e,"gi");for(let e of t){const t=e.getElementsByTagName("td");let n=!1;for(let e of t)e.textContent.match(o)&&(n=!0,e.innerHTML=e.textContent.replace(o,(e=>`<span class="bg-yellow-100">${e}</span>`)));e.style.display=n?"":"none"}}}))}),300)}function openImageModal(e){const t=document.createElement("div");t.className="fixed inset-0 bg-black bg-opacity-0 flex items-center justify-center z-50 p-4 transition-opacity duration-300 ease-in-out",t.innerHTML=`\n                <div class="relative max-w-4xl w-full transform transition-all duration-300 ease-in-out scale-95 opacity-0">\n                    <img src="${e}" alt="Book cover" class="w-full max-h-[90vh] object-contain">\n                    <button onclick="this.parentElement.parentElement.remove()"\n                            class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300">\n                        &times;\n                    </button>\n                </div>\n            `,document.body.appendChild(t),setTimeout((()=>{t.classList.add("bg-opacity-75"),t.querySelector("div").classList.remove("scale-95","opacity-0"),t.querySelector("div").classList.add("scale-100","opacity-100")}),10)}function openDescriptionModal(e){const t=document.createElement("div");t.className="fixed inset-0 bg-black bg-opacity-0 flex items-center justify-center z-50 p-4 transition-opacity duration-300 ease-in-out",t.innerHTML=`\n                <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto transform transition-all duration-300 ease-in-out scale-95 opacity-0">\n                    <div class="flex justify-between items-center mb-4">\n                        <h3 class="text-lg font-medium">Book Description</h3>\n                        <button onclick="this.parentElement.parentElement.parentElement.remove()"\n                                class="text-gray-400 hover:text-gray-500">\n                            <i data-feather="x" class="w-5 h-5"></i>\n                        </button>\n                    </div>\n                    <p class="text-gray-700 whitespace-pre-wrap">${e}</p>\n                </div>\n            `,document.body.appendChild(t),setTimeout((()=>{t.classList.add("bg-opacity-75"),t.querySelector("div").classList.remove("scale-95","opacity-0"),t.querySelector("div").classList.add("scale-100","opacity-100")}),10),feather.replace()}document.getElementById("isbn").addEventListener("input",(function(e){formatISBN(e.target)})),document.getElementById("isbnForm").addEventListener("submit",(function(e){if(e.preventDefault(),!validateISBN())return;const t=document.getElementById("isbn").value.replace(/\D/g,""),o=document.getElementById("location").value;fetch("https://jbooks.eu.pythonanywhere.com/api/entries",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isbn:t,location:o})}).then((e=>e.ok?e.json():e.json().then((e=>{throw e})))).then((e=>{e.error?Swal.fire({icon:"error",title:"Error",text:e.error,toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}):(Swal.fire({icon:"success",title:"Success",text:e.message,toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}),fetchEntries(),closeAddEntryModal(),document.getElementById("isbn").value="",document.getElementById("location").value="")})).catch((e=>{console.error("Error submitting ISBN:",e),Swal.fire({icon:"error",title:"Error",text:e.error||"An error occurred while adding the book",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3})}))})),AOS.init({duration:600,easing:"ease-out-quad",once:!0}),feather.replace(),document.addEventListener("DOMContentLoaded",(()=>{fetchEntries(),setInterval(fetchEntries,1e4),document.getElementById("searchInput").addEventListener("input",searchEntries),document.getElementById("searchInput").addEventListener("keypress",(function(e){"Enter"===e.key&&searchEntries()}))}));const codeReader=new ZXing.BrowserMultiFormatReader;let selectedDeviceId=null,stream=null;function openScannerModal(){document.getElementById("scannerModal").classList.remove("hidden"),setTimeout((()=>{document.getElementById("scannerModal").classList.add("bg-opacity-50");const e=document.querySelector("#scannerModal > div");e.classList.remove("scale-95","opacity-0"),e.classList.add("scale-100","opacity-100")}),10),startScanner()}async function startScanner(){try{const e=await codeReader.listVideoInputDevices();if(0===e.length)return void Swal.fire("No camera found","Please connect a camera","error");selectedDeviceId=e[0].deviceId;const t=document.getElementById("scanner");await codeReader.decodeFromVideoDevice(selectedDeviceId,t,(async(e,t)=>{if(e){const t=e.getText();/^97[89]\d{10}$/.test(t)?fetch("/api/entries",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isbn:t,location:"N/A"})}).then((async e=>{if(e.ok){const t=await e.json();Swal.fire({toast:!0,position:"top-end",icon:"success",title:`Added: ${t.name}`,showConfirmButton:!1,timer:2e3}),fetchEntries()}else{const t=await e.json();Swal.fire({toast:!0,position:"top-end",icon:"error",title:t.error||"Failed to add",showConfirmButton:!1,timer:2e3})}})):Swal.fire({toast:!0,position:"top-end",icon:"warning",title:"Not a valid ISBN-13",showConfirmButton:!1,timer:2e3})}}))}catch(e){console.error(e),Swal.fire("Error",e.message,"error")}}function closeScannerModal(){document.getElementById("scannerModal").classList.add("hidden");document.querySelector("#scannerModal > div").classList.add("scale-95","opacity-0"),codeReader.reset()}function openAddEntryModal(){const e=document.getElementById("addEntryModal");e.classList.remove("hidden"),setTimeout((()=>{e.classList.add("bg-opacity-50");const t=e.querySelector("div");t.classList.remove("scale-95","opacity-0"),t.classList.add("scale-100","opacity-100")}),10)}function closeAddEntryModal(){const e=document.getElementById("addEntryModal");e.classList.add("hidden");e.querySelector("div").classList.add("scale-95","opacity-0")}
